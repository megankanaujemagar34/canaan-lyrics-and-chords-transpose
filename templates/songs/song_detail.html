<!DOCTYPE html>
<html>
<head>
    <title>{{ song.title }}</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Mono&display=swap');
        body {
            font-family: Arial, sans-serif;
        }
        pre {
            font-family: 'Noto Sans Mono', monospace;
            white-space: pre;
            font-size: 16px;
            line-height: 1.6;
        }
        .controls button {
            padding: 8px 12px;
            margin-right: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .chord {
            color: darkred;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h1>{{ song.title }}</h1>

<div class="controls">
    <button onclick="transpose(-1)">➖ Transpose Down</button>
    <button onclick="transpose(1)">➕ Transpose Up</button>
</div>

<pre id="song-text"></pre>

<script>
const rawSongText = `{{ song.lyrics_and_chords|escapejs }}`;
</script>


<a href="/">← Back to songs</a>

<script>
const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const chordRegex = /\[([A-G])(#|b)?(.*?)]/g;

let currentText = rawSongText;

renderSong(currentText);

function transpose(step) {
    currentText = currentText.replace(chordRegex, function(match, root, accidental, suffix) {
        let base = root + (accidental || "");
        let index = notes.indexOf(base);
        if (index === -1) return match;

        let newIndex = (index + step + notes.length) % notes.length;
        return "[" + notes[newIndex] + suffix + "]";
    });

    renderSong(currentText);
}

function renderSong(text) {
    const lines = text.split("\n");
    let output = "";

    lines.forEach(line => {
        if (!line.includes("[")) {
            output += line + "\n";
            return;
        }

        let chordLine = "";
        let lyricLine = "";
        let i = 0;

        while (i < line.length) {
            if (line[i] === "[") {
                let end = line.indexOf("]", i);
                let chord = line.substring(i, end + 1);

                chordLine += chord;
                lyricLine += " ".repeat(chord.length);

                i = end + 1;
            } else {
                chordLine += " ";
                lyricLine += line[i];
                i++;
            }
        }

        output += chordLine + "\n" + lyricLine + "\n";
    });

    document.getElementById("song-text").innerText = output;
}
</script>



</body>
</html>
